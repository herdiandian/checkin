<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Attendance Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: black;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    }
    #reader {
      width: 100vw;
      height: 100vh;
      position: relative;
    }
    /* Force video feed to cover full screen (fix black bar issue on phones) */
    #reader video {
      object-fit: cover !important;
      width: 100% !important;
      height: 100% !important;
    }
    .floating-btn {
      position: absolute;
      bottom: 20px;
      z-index: 30;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .floating-btn img {
      width: 28px;
      height: 28px;
    }
    #switchCameraBtn {
      right: 20px;
    }
    #manualBtn {
      right: 100px;
    }
    /* Loading overlay */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(3px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 25;
      display: none;
    }
    #loadingOverlay img {
      width: 90px;
      height: 90px;
      animation: spin 10s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    @keyframes scaleBounce {
      0%   { transform: scale(0.7); opacity: 0; }
      60%  { transform: scale(1.05); opacity: 1; }
      80%  { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    
    .popup-animate {
      animation: scaleBounce 0.6s ease-out;
    }

  </style>
</head>
<body>
  <div id="reader"></div>

  <!-- Floating Switch Button with SVG -->
  <button id="switchCameraBtn" class="floating-btn">
    <img src="reverse-camera-solid.svg" alt="Switch Camera">
  </button>
  <button id="manualBtn" class="floating-btn">
    <strong style="font-size:2rem;line-height:1;">+</strong>
  </button>

  <!-- Loading Overlay with custom SVG -->
  <div id="loadingOverlay">
    <img src="spinner-ring.svg" alt="Loading...">
  </div>

  <!-- Fullscreen Bootstrap Modal -->
  <div class="modal fade" id="popupModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content border-0 bg-dark bg-opacity-75 d-flex justify-content-center align-items-center">
        <div class="modal-body text-center text-white popup-container">
          <h1 id="popupName" class="fw-bold display-1"></h1>
          <h3 id="popupType" class="mt-3 display-5"></h3>
        </div>
      </div>
    </div>
  </div>


  <script>
    let currentCamera = "environment"; 
    let html5QrcodeScanner;
    let lastScanned = "";
    let lastName = "";
    let lastType = "";
    let app_id = "AKfycbw_GSMkL4vuPbFGdjH8fvfeEdR71MFfUFcc613CmoO7k0A2lthOP-_xIvMIEWK5-0rQ";

    function showPopup(name, type, status="success") {
      Swal.fire({
        icon: status,
        title: `<div style="font-size:2.5rem; font-weight:bold;">${name}</div>`,
        html: `<div style="font-size:1.5rem; color:#444;">${type}</div>`,
        showConfirmButton: false,
        timer: 5000,
        background: "#f8f9fa",
        backdrop: true
      });
    }

    function showPopupName(name, type) {
      const popupName = document.getElementById("popupName");
      const popupType = document.getElementById("popupType");
      const popupContainer = document.querySelector("#popupModal .popup-container");
    
      popupName.textContent = name;
      popupType.textContent = type;
    
      const modalElement = document.getElementById("popupModal");
      const modal = new bootstrap.Modal(modalElement, {
        backdrop: true,
        keyboard: true
      });
    
      // Reset animation
      popupContainer.classList.remove("popup-animate");
      void popupContainer.offsetWidth; // force reflow
      popupContainer.classList.add("popup-animate");
    
      modal.show();
    
      // Auto-close after 4 seconds
      setTimeout(() => {
        modal.hide();
      }, 4000);
    
      // Close modal if anywhere clicked
      modalElement.addEventListener("click", () => {
        modal.hide();
      }, { once: true });
    }


    function showLoading() {
      document.getElementById("loadingOverlay").style.display = "flex";
    }

    function hideLoading() {
      document.getElementById("loadingOverlay").style.display = "none";
    }

    function logToSheet(id) {
      showLoading();
      const url = 'https://script.google.com/macros/s/'+app_id+'/exec?id='+id;
      // https://script.google.com/macros/s/AKfycbw_GSMkL4vuPbFGdjH8fvfeEdR71MFfUFcc613CmoO7k0A2lthOP-_xIvMIEWK5-0rQ/exec?id=1
      fetch(url)
        .then(res => res.json())
        .then(data => {
          hideLoading();
          lastName = data.name;
          lastType = data.type;
          up(data.name, data.type, "success");
        })
        .catch(() => {
          hideLoading();
          up("Error", "⚠️ Failed to log attendance", "error");
        });
    }

    function logManual(name, type) {
      showLoading();
      const url = 'https://script.google.com/macros/s/'+app_id+'/exec?name='+encodeURIComponent(name)+'&type='+encodeURIComponent(type);
      fetch(url)
        .then(res => res.json())
        .then(data => {
          hideLoading();
          lastName = data.name;
          lastType = data.type;
          showPopupName(data.name, data.type);
        })
        .catch(() => {
          hideLoading();
          showPopup("Error", "⚠️ Failed to log manual entry", "error");
        });
    }



    function onScanSuccess(decodedText) {
      if (decodedText === lastScanned) {
        // Show "Already Scanned" with same name/type
        // if (lastName && lastType) {
        //   showPopup(lastName, `${lastType} (Already Scanned)`, "info");
        // } else {
        //   showPopup("Already Scanned", "", "info");
        // }
        return;
      }
      lastScanned = decodedText;

      // Send scanned QR to Google Sheet endpoint
      logToSheet(decodedText);
    }

    async function startScanner(cameraFacing) {
      if (html5QrcodeScanner) {
        await html5QrcodeScanner.stop().catch(() => {});
      }
      html5QrcodeScanner = new Html5Qrcode("reader");
      html5QrcodeScanner.start(
        { facingMode: cameraFacing },
        {
          fps: 10,
          qrbox: function(viewfinderWidth, viewfinderHeight) {
            let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
            return { width: minEdge * 0.7, height: minEdge * 0.85 };
          }
        },
        onScanSuccess
      ).catch(err => {
        Swal.fire("⚠️ Camera not available", "", "error");
      });
    }

    // Start with back camera
    startScanner(currentCamera);

    // Switch camera button
    document.getElementById("switchCameraBtn").addEventListener("click", () => {
      currentCamera = currentCamera === "environment" ? "user" : "environment";
      startScanner(currentCamera);
    });

    // Manual input button
    document.getElementById("manualBtn").addEventListener("click", () => {
      Swal.fire({
        title: "Input Tamu",
        html: `
          <div class="container text-start">
            <div class="mb-3">
              <input type="text" id="manualName" class="form-control form-control-lg" placeholder="Nama">
            </div>
            <div class="mb-0">
              <input type="text" id="manualType" class="form-control form-control-lg" placeholder="Alamat">
            </div>
          </div>
        `,
        focusConfirm: false,
        showCancelButton: false,
        confirmButtonText: "Simpan",
        preConfirm: () => {
          const name = document.getElementById("manualName").value.trim();
          const type = document.getElementById("manualType").value.trim();
          if (!name || !type) {
            Swal.showValidationMessage("Harap mengisi data");
            return false;
          }
          return { name, type };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          logManual(result.value.name, result.value.type);
        }
      });
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>







